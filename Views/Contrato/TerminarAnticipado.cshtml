@model ProyectoInmobiliaria.Models.Contrato

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg border-0 rounded-3">
                <div class="card-header bg-dark text-white">
                    <h3 class="mb-0">Finalizar Contrato Anticipadamente</h3>
                </div>
                <div class="card-body p-4">
                    <form asp-controller="Contrato" asp-action="TerminarAnticipado" method="post" id="terminarForm">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="id" value="@Model.IdContrato" />

                        <div class="mb-3">
                            <label class="form-label fw-bold">Fecha de Inicio</label>
                            <input type="date" class="form-control" value="@Model.FechaInicio.ToString("yyyy-MM-dd")" readonly />
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Fecha de Fin Original</label>
                            <input type="date" class="form-control" value="@Model.FechaFin.ToString("yyyy-MM-dd")" readonly />
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Fecha de Terminaci√≥n Anticipada</label>
                            <input type="date" name="fechaAnticipada" class="form-control" 
                                   id="fechaAnticipada"
                                   min="@Model.FechaInicio.ToString("yyyy-MM-dd")" 
                                   max="@Model.FechaFin.ToString("yyyy-MM-dd")" />
                            <span class="text-danger small" asp-validation-for="FechaAnticipada"></span>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Multa Calculada</label>
                            <input type="text" class="form-control" id="multaCalculada" value="@Model.Multa?.ToString("C")" readonly />
                        </div>

                        <div class="d-flex justify-content-end mt-4">
                            <a asp-action="Index" asp-controller="Contrato" class="btn btn-secondary me-2">Cancelar</a>
                            <button type="submit" class="btn btn-danger">Finalizar Contrato</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const fechaInicio = new Date("@Model.FechaInicio.ToString("yyyy-MM-dd")T00:00:00");
            const fechaFin = new Date("@Model.FechaFin.ToString("yyyy-MM-dd")T00:00:00");
            const precio = @System.Text.Json.JsonSerializer.Serialize(Model.Precio);

            const fechaInput = document.getElementById("fechaAnticipada");
            const multaInput = document.getElementById("multaCalculada");

            function calcularMulta() {
                if (!fechaInput.value) {
                    multaInput.value = "$ 0,00";
                    return;
                }

                const fechaSeleccionada = new Date(fechaInput.value + "T00:00:00");
                if (fechaSeleccionada < fechaInicio || fechaSeleccionada > fechaFin) {
                    multaInput.value = "$ 0,00";
                    return;
                }

                const totalDias = (fechaFin - fechaInicio) / (1000 * 60 * 60 * 24);
                const diasCumplidos = (fechaSeleccionada - fechaInicio) / (1000 * 60 * 60 * 24);

                const multa = (diasCumplidos < totalDias / 2) ? precio * 2 : precio;
                multaInput.value = new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(multa);
            }

            fechaInput.addEventListener("change", calcularMulta);
            if (fechaInput.value) calcularMulta();
        });
    </script>
}
